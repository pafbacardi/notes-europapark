<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes des Attractions Europa-Park & Rulantica</title>
    <script type="module">
        // Importation des modules Firebase n√©cessaires
        // Ajout de 'writeBatch' pour les op√©rations par lots
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, addDoc, getDocs, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales pour Firebase (initialis√©es plus tard)
        let app;
        let db;
        let auth;
        let userId; // L'ID de l'utilisateur Firebase

        // Variables globales fournies par l'environnement Canvas (NE PAS MODIFIER)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // L'initialAuthToken est toujours fourni par l'environnement Canvas
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Configuration Firebase directe (utilisant les informations que tu as fournies) ---
        // Cette configuration est maintenant cod√©e en dur pour √©viter les probl√®mes de transmission via __firebase_config.
        const firebaseConfig = {
            apiKey: "AIzaSyBteaEF6X5B-NmKBaTj05PsHhEkpGm4WR0",
            authDomain: "notes-europapark-861c5.firebaseapp.com",
            projectId: "notes-europapark-861c5",
            storageBucket: "notes-europapark-861c5.firebasestorage.app",
            messagingSenderId: "143494361989",
            appId: "1:143494361989:web:ac191fdb04c73967aa8aec"
        };


        // --- Donn√©es des attractions (initialement vide, sera charg√©e depuis Firebase) ---
        let attractions = [];
        // Stockage des notes (maintenant persistant avec Firebase)
        const allRatings = {}; // Structure: { attractionId: { memberName: rating, ... }, ... }

        let currentAttraction = null; // Garde l'attraction actuellement affich√©e
        let sortAscending = false; // Pour le tri par note
        let selectedRatingValue = 1; // Nouvelle variable pour stocker la note s√©lectionn√©e par les boutons
        let searchQuery = ''; // Nouvelle variable pour la recherche

        // Membres de la famille avec leurs couleurs
        const familyMembers = [
            { name: 'Papa', color: '#4169E1' },    // RoyalBlue
            { name: 'Maman', color: '#FF8C00' },    // DarkOrange
            { name: 'Ceylian', color: '#DC143C' },  // Crimson
            { name: 'Clo√©lie', color: '#000000' }   // Noir
        ];

        // --- R√©cup√©ration des √©l√©ments du DOM ---
        const mainListPage = document.getElementById('main-list-page');
        const attractionDetailPage = document.getElementById('attraction-detail-page');
        const statsPage = document.getElementById('stats-page');
        const manageAttractionsPage = document.getElementById('manage-attractions-page');
        const attractionListDiv = document.getElementById('attractionList');
        const detailAttractionName = document.getElementById('detail-attraction-name');
        const detailAttractionPark = document.getElementById('detail-attraction-park');
        const detailAttractionZone = document.getElementById('detail-attraction-zone');
        const detailAttractionCategory = document.getElementById('detail-attraction-category');
        const detailAttractionUrl = document.getElementById('detail-attraction-url');
        const detailAttractionImage = document.getElementById('detail-attraction-image');
        const ratingButtonsContainer = document.getElementById('ratingButtonsContainer');
        const familyRaterButtonsDiv = document.getElementById('familyRaterButtons');
        const familyRatingsList = document.getElementById('familyRatingsList');
        const averageRatingSpan = document.getElementById('averageRating');

        // Stats elements
        const personSelectForStats = document.getElementById('personSelectForStats');
        const individualRatingsList = document.getElementById('individualRatingsList');
        const averageByPersonList = document.getElementById('averageByPersonList');
        const averageByZoneList = document.getElementById('averageByZoneList');
        const averageByCategoryList = document.getElementById('averageByCategoryList');

        // Filter elements
        const zoneFilterSelect = document.getElementById('zoneFilter');
        const showUnratedButton = document.getElementById('showUnratedButton');
        const sortByRatingButton = document.getElementById('sortByRatingButton');
        const attractionSearchInput = document.getElementById('attractionSearchInput'); // Nouvel √©l√©ment de recherche
        let filterUnratedOnly = false;

        // Manage Attractions elements
        const attractionFormTitle = document.getElementById('attractionFormTitle');
        const attractionIdToEdit = document.getElementById('attractionIdToEdit');
        const attractionNameInput = document.getElementById('attractionName');
        const attractionParkSelect = document.getElementById('attractionPark');
        const attractionZoneInput = document.getElementById('attractionZone');
        const attractionCategorySelect = document.getElementById('attractionCategory');
        const attractionUrlInput = document.getElementById('attractionUrl');
        const attractionImageUrlInput = document.getElementById('attractionImageUrl');
        const saveAttractionButton = document.getElementById('saveAttractionButton');
        const currentManagedAttractionsList = document.getElementById('currentManagedAttractionsList');

        // Custom Modal elements
        const customConfirmModal = document.getElementById('customConfirmModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmYes = document.getElementById('modalConfirmYes');
        const modalConfirmNo = document.getElementById('modalConfirmNo');

        // Password Modal elements
        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const passwordOkButton = document.getElementById('passwordOkButton');
        const passwordCancelButton = document.getElementById('passwordCancelButton');
        const CORRECT_PASSWORD = 'EP2025';

        // Test Notes Options Modal elements
        const testNotesOptionsModal = document.getElementById('testNotesOptionsModal');
        const generateTestNotesButton = document.getElementById('generateTestNotesButton');
        const deleteAllNotesButton = document.getElementById('deleteAllNotesButton');
        const cancelTestNotesButton = document.getElementById('cancelTestNotesButton');

        // Loading indicator (display none by default in CSS now)
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Global variable to track which action requested the password
        let currentPasswordAction = null; // 'manageAttractions' or 'testNotes'

        // Flags pour le chargement initial des donn√©es
        let attractionsLoaded = false;
        let ratingsLoaded = false;


        // --- Fonctions d'affichage des pages ---
        function showLoading() {
            console.log("SHOW LOADING: Affichage de l'overlay de chargement.");
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            console.log("HIDE LOADING: Masquage de l'overlay de chargement.");
            loadingOverlay.style.display = 'none';
        }

        // V√©rifie si les deux types de donn√©es sont charg√©s et masque le spinner
        function checkAndHideLoading() {
            console.log(`CHECK AND HIDE LOADING: Attractions charg√©es: ${attractionsLoaded}, Notes charg√©es: ${ratingsLoaded}`);
            if (attractionsLoaded && ratingsLoaded) {
                hideLoading();
            }
        }

        function hideAllPages() {
            mainListPage.style.display = 'none';
            attractionDetailPage.style.display = 'none';
            statsPage.style.display = 'none';
            manageAttractionsPage.style.display = 'none';
            testNotesOptionsModal.classList.remove('visible'); // S'assurer que la modale d'options est cach√©e
        }

        function showMainListPage() {
            hideAllPages();
            mainListPage.style.display = 'block';
            renderAttractionList(); // Re-render pour mettre √† jour les moyennes sur les cartes et appliquer les filtres
            populateZoneFilter(); // Met √† jour les options du filtre de zone
        }

        function showDetailPage(attractionId) {
            hideAllPages();
            currentAttraction = attractions.find(att => att.id === attractionId);
            if (!currentAttraction) {
                console.error("Attraction non trouv√©e dans showDetailPage:", attractionId);
                showCustomAlert("L'attraction demand√©e n'a pas √©t√© trouv√©e.");
                showMainListPage();
                return;
            }
            console.log("showDetailPage: currentAttraction d√©fini comme", currentAttraction.name);

            detailAttractionName.textContent = currentAttraction.name;
            detailAttractionPark.textContent = currentAttraction.park;
            detailAttractionZone.textContent = currentAttraction.zone;
            detailAttractionCategory.textContent = currentAttraction.category;

            if (currentAttraction.url) {
                detailAttractionUrl.href = currentAttraction.url;
                detailAttractionUrl.style.display = 'inline';
            } else {
                detailAttractionUrl.style.display = 'none';
            }

            if (currentAttraction.imageUrl) {
                detailAttractionImage.src = currentAttraction.imageUrl;
                detailAttractionImage.alt = `Image de ${currentAttraction.name}`;
                detailAttractionImage.style.display = 'block';
            } else {
                detailAttractionImage.src = "https://placehold.co/400x250/cccccc/333333?text=Image+non+disponible";
                detailAttractionImage.alt = "Image non disponible";
                detailAttractionImage.style.display = 'block';
            }

            selectedRatingValue = 1; // R√©initialise la note s√©lectionn√©e
            renderRatingButtons(); // Affiche les boutons de notation
            updateRatingsDisplay(); // Met √† jour l'affichage des notes existantes
            attractionDetailPage.style.display = 'block';
        }

        function showStatsPage() {
            hideAllPages();
            statsPage.style.display = 'block';
            renderIndividualRatingsForPerson();
            renderAverageByPerson();
            renderAverageByZone();
            renderAverageByCategory();
        }

        function requestManageAttractionsAccess() {
            currentPasswordAction = 'manageAttractions';
            passwordModal.classList.add('visible');
            passwordInput.value = '';
            passwordInput.focus();
        }

        function showManageAttractionsPage() {
            hideAllPages();
            manageAttractionsPage.style.display = 'block';
            openAttractionForm();
            renderManagedAttractionsList();
        }

        // Nouvelle fonction pour demander l'acc√®s √† la gestion des notes de test
        function requestTestNotesManagementAccess() {
            currentPasswordAction = 'testNotes';
            passwordModal.classList.add('visible');
            passwordInput.value = '';
            passwordInput.focus();
        }

        // Nouvelle fonction pour afficher la modale avec les options de notes de test
        function showTestNotesOptionsModal() {
            testNotesOptionsModal.classList.add('visible');
        }

        // --- Fonctions de gestion des attractions (maintenant persistantes avec Firebase) ---

        function openAttractionForm(attractionId = null) {
            let attraction = null;
            if (attractionId) {
                attraction = attractions.find(att => att.id === attractionId);
                if (!attraction) {
                    console.error("Attraction √† modifier non trouv√©e:", attractionId);
                    attractionFormTitle.textContent = 'Ajouter une nouvelle attraction';
                    attractionIdToEdit.value = '';
                    attractionNameInput.value = '';
                    attractionParkSelect.value = 'Europa-Park';
                    attractionZoneInput.value = '';
                    attractionCategorySelect.value = 'Famille';
                    attractionUrlInput.value = '';
                    attractionImageUrlInput.value = '';
                    saveAttractionButton.textContent = 'Ajouter l\'attraction';
                    return;
                }
            }

            if (attraction) {
                attractionFormTitle.textContent = `Modifier : ${attraction.name}`;
                attractionIdToEdit.value = attraction.id;
                attractionNameInput.value = attraction.name;
                attractionParkSelect.value = attraction.park;
                attractionZoneInput.value = attraction.zone;
                attractionCategorySelect.value = attraction.category;
                attractionUrlInput.value = attraction.url || '';
                attractionImageUrlInput.value = attraction.imageUrl || '';
                saveAttractionButton.textContent = 'Mettre √† jour l\'attraction';
            } else {
                attractionFormTitle.textContent = 'Ajouter une nouvelle attraction';
                attractionIdToEdit.value = '';
                attractionNameInput.value = '';
                attractionParkSelect.value = 'Europa-Park';
                attractionZoneInput.value = '';
                attractionCategorySelect.value = 'Famille';
                attractionUrlInput.value = '';
                attractionImageUrlInput.value = '';
                saveAttractionButton.textContent = 'Ajouter l\'attraction';
            }
        }

        async function saveAttraction() {
            if (!db) {
                showCustomAlert("Firebase n'est pas initialis√©. Veuillez r√©essayer.");
                return;
            }

            const id = attractionIdToEdit.value;
            const name = attractionNameInput.value.trim();
            const park = attractionParkSelect.value;
            const zone = attractionZoneInput.value.trim();
            const category = attractionCategorySelect.value;
            const url = attractionUrlInput.value.trim();
            const imageUrl = attractionImageUrlInput.value.trim();

            if (!name || !park || !zone || !category) {
                showCustomAlert("Veuillez remplir tous les champs obligatoires (Nom, Parc, Zone, Cat√©gorie).");
                return;
            }

            showLoading();
            try {
                const attractionData = { name, park, zone, category, url, imageUrl };
                const attractionsColRef = collection(db, `artifacts/${appId}/public/data/attractions`);

                if (id) {
                    // Mise √† jour d'une attraction existante dans Firestore
                    await setDoc(doc(attractionsColRef, id), attractionData);
                    showCustomAlert(`Attraction "${name}" mise √† jour !`);
                } else {
                    // Ajout d'une nouvelle attraction dans Firestore
                    const newDocRef = await addDoc(attractionsColRef, attractionData);
                    showCustomAlert(`Attraction "${name}" ajout√©e avec l'ID: ${newDocRef.id} !`);
                }
                // Les affichages seront mis √† jour par l'onSnapshot
                openAttractionForm(); // R√©initialise le formulaire
            } catch (error) {
                console.error("Erreur lors de la sauvegarde de l'attraction :", error);
                showCustomAlert("Erreur lors de la sauvegarde de l'attraction. Veuillez r√©essayer.");
            } finally {
                hideLoading();
            }
        }

        async function deleteAttraction(attractionId) {
            if (!db) {
                showCustomAlert("Firebase n'est pas initialis√©. Veuillez r√©essayer.");
                return;
            }

            const attractionToDelete = attractions.find(att => att.id === attractionId);
            if (!attractionToDelete) return;

            showCustomConfirm(`Voulez-vous vraiment supprimer l'attraction "${attractionToDelete.name}" ?`, async (confirmed) => {
                if (confirmed) {
                    showLoading();
                    try {
                        // Supprimer l'attraction de la collection 'attractions'
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/attractions`, attractionId));

                        // Supprimer les notes associ√©es de la collection 'ratings'
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/ratings`, attractionId));

                        showCustomAlert(`Attraction "${attractionToDelete.name}" et ses notes supprim√©es !`);
                        // Les affichages seront mis √† jour par l'onSnapshot
                    } catch (error) {
                        console.error("Erreur lors de la suppression de l'attraction :", error);
                        showCustomAlert("Erreur lors de la suppression de l'attraction. Veuillez r√©essayer.");
                    } finally {
                        hideLoading();
                    }
                } else {
                    showCustomAlert(`Suppression de "${attractionToDelete.name}" annul√©e.`);
                }
            });
        }

        function renderManagedAttractionsList() {
            currentManagedAttractionsList.innerHTML = '';
            if (attractions.length === 0) {
                currentManagedAttractionsList.innerHTML = '<p style="margin-top: 15px; font-style: italic; color: #666;">Aucune attraction n\'est encore enregistr√©e.</p>';
                return;
            }

            attractions.forEach(attraction => {
                const li = document.createElement('li');
                const parkIndicatorClass = attraction.park === 'Europa-Park' ? 'europa-park' : 'rulantica';
                li.innerHTML = `
                    <div class="attraction-info">
                        ${attraction.name} (${attraction.park} <span class="park-indicator ${parkIndicatorClass}"></span>)
                    </div>
                    <div class="attraction-actions">
                        <button class="edit-button" onclick="openAttractionForm('${attraction.id}')">Modifier</button>
                        <button class="delete-button" onclick="deleteAttraction('${attraction.id}')">Supprimer</button>
                    </div>
                `;
                currentManagedAttractionsList.appendChild(li);
            });
        }

        // --- G√©n√©ration de la liste des attractions avec filtres et tri ---
        function renderAttractionList() {
            attractionListDiv.innerHTML = '';
            const selectedZone = zoneFilterSelect.value;
            const lowerCaseSearchQuery = searchQuery.toLowerCase(); // Convertir la requ√™te de recherche en minuscules

            let filteredAndSortedAttractions = attractions.filter(attraction => {
                // Filtrer par zone
                if (selectedZone !== 'all' && attraction.zone !== selectedZone) {
                    return false;
                }
                // Filtrer par non not√©es
                if (filterUnratedOnly) {
                    const attractionRatings = allRatings[attraction.id] || {};
                    const hasAnyRating = familyMembers.some(member => attractionRatings[member.name] !== undefined);
                    return !hasAnyRating;
                }
                // Filtrer par recherche (nom de l'attraction)
                if (lowerCaseSearchQuery && !attraction.name.toLowerCase().includes(lowerCaseSearchQuery)) {
                    return false;
                }
                return true;
            });

            if (sortAscending) {
                filteredAndSortedAttractions.sort((a, b) => {
                    const avgA = calculateAverageRatingForAttraction(a.id);
                    const avgB = calculateAverageRatingForAttraction(b.id);
                    // G√®re les cas o√π les moyennes sont 'N/A' pour le tri
                    if (avgA === 'N/A' && avgB === 'N/A') return 0;
                    if (avgA === 'N/A') return 1; // Les non not√©es vont √† la fin
                    if (avgB === 'N/A') return -1; // Les non not√©es vont √† la fin
                    return avgB - avgA; // Trie du plus grand au plus petit
                });
            }

            if (filteredAndSortedAttractions.length === 0) {
                attractionListDiv.innerHTML = '<p style="margin-top: 30px; font-style: italic; color: #666;">Aucune attraction ne correspond √† vos crit√®res de filtre.</p>';
                return;
            }

            filteredAndSortedAttractions.forEach(attraction => {
                const averageAttractionDisplay = calculateAverageRatingForAttraction(attraction.id) !== 'N/A'
                    ? `Moyenne: ${ calculateAverageRatingForAttraction(attraction.id) }/10`
                    : 'Non not√©e';
                const parkIndicatorClass = attraction.park === 'Europa-Park' ? 'europa-park' : 'rulantica';
                const card = document.createElement('div');
                card.className = 'attraction-card';
                card.innerHTML = `
                    <h3>${attraction.name}</h3>
                    <p><strong>Parc :</strong> ${attraction.park} <span class="park-indicator ${parkIndicatorClass}"></span></p>
                    <p><strong>Zone :</strong> ${attraction.zone}</p>
                    <span class="category ${attraction.category}">${attraction.category}</span>
                    <p class="average-on-card">${averageAttractionDisplay}</p>
                    <button class="rate-attraction-button" onclick="showDetailPage('${attraction.id}')">Noter cette attraction</button>
                `;
                attractionListDiv.appendChild(card);
            });
        }

        function calculateAverageRatingForAttraction(attractionId) {
            let totalAttractionScore = 0;
            let numAttractionRatings = 0;
            const attractionRatings = allRatings[attractionId] || {};

            familyMembers.forEach(member => {
                if (attractionRatings[member.name] !== undefined) {
                    totalAttractionScore += attractionRatings[member.name];
                    numAttractionRatings++;
                }
            });
            return numAttractionRatings > 0 ? parseFloat((totalAttractionScore / numAttractionRatings).toFixed(1)) : 'N/A';
        }

        function populateZoneFilter() {
            const zonesMap = new Map(); // Map pour stocker {zone: park} pour √©viter les doublons et obtenir le parc
            attractions.forEach(att => {
                if (!zonesMap.has(att.zone)) {
                    zonesMap.set(att.zone, att.park);
                }
            });

            zoneFilterSelect.innerHTML = '<option value="all">Toutes les zones</option>';
            const sortedZones = Array.from(zonesMap.keys()).sort(); // Trie les noms de zone

            sortedZones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone;
                const park = zonesMap.get(zone);
                // Utilise des √©mojis pour l'indicateur de parc dans l'option
                let emoji = '';
                if (park === 'Europa-Park') {
                    emoji = 'üîµ '; // Cercle bleu pour Europa-Park
                } else if (park === 'Rulantica') {
                    emoji = 'üíß '; // Goutte d'eau pour Rulantica
                }
                option.textContent = `${emoji}${zone}`; // Ajoute l'√©moji au texte de l'option
                zoneFilterSelect.appendChild(option);
            });
        }

        // Nouvelle fonction pour g√©n√©rer les boutons de notation (1 √† 10)
        function renderRatingButtons() {
            ratingButtonsContainer.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = `rating-button rating-${i}`; // Ajoute une classe pour la couleur
                if (i === selectedRatingValue) {
                    button.classList.add('selected'); // Marque le bouton s√©lectionn√©
                }
                button.onclick = () => {
                    selectedRatingValue = i;
                    // Supprime la classe 'selected' de tous les boutons
                    document.querySelectorAll('.rating-button').forEach(btn => btn.classList.remove('selected'));
                    // Ajoute la classe 'selected' au bouton cliqu√©
                    button.classList.add('selected');
                };
                ratingButtonsContainer.appendChild(button);
            }
        }

        function renderFamilyRaterButtons() {
            familyRaterButtonsDiv.innerHTML = '';
            familyMembers.forEach(member => {
                const button = document.createElement('button');
                button.textContent = member.name;
                button.className = member.name.toLowerCase();
                button.onclick = () => submitRating(member.name);
                familyRaterButtonsDiv.appendChild(button);
            });
        }

        async function submitRating(user) {
            if (!db) {
                showCustomAlert("Firebase n'est pas initialis√©. Veuillez r√©essayer.");
                return;
            }
            if (!currentAttraction) {
                showCustomAlert("Veuillez s√©lectionner une attraction avant de donner une note.");
                return;
            }
            const rating = selectedRatingValue;

            const attractionId = currentAttraction.id;
            const ratingDocRef = doc(db, `artifacts/${appId}/public/data/ratings`, attractionId);

            showLoading();
            try {
                // Met √† jour la note pour le membre sp√©cifique dans le document de notes de l'attraction
                // Utilise setDoc avec merge: true pour cr√©er le document s'il n'existe pas, ou fusionner s'il existe
                await setDoc(ratingDocRef, { [user]: rating }, { merge: true });

                triggerConfetti();
                showCustomAlert(`Note de ${rating}/10 enregistr√©e pour ${currentAttraction.name} par ${user} !`);
                // Les affichages seront mis √† jour par l'onSnapshot
            } catch (error) {
                console.error("Erreur lors de la soumission de la note :", error);
                showCustomAlert("Erreur lors de l'enregistrement de la note. Veuillez r√©essayer.");
            } finally {
                hideLoading();
            }
        }

        async function generateTestRatings() {
            if (!db) {
                showCustomAlert("Firebase n'est pas initialis√©. Veuillez r√©essayer.");
                return;
            }

            showLoading();
            try {
                const ratingsColRef = collection(db, `artifacts/${appId}/public/data/ratings`);
                // Utilisation de writeBatch(db) pour cr√©er un nouveau batch
                const batch = writeBatch(db);

                // Supprimer toutes les notes existantes (pour un re-g√©n√©ration propre)
                const existingRatingsSnapshot = await getDocs(ratingsColRef);
                existingRatingsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // G√©n√©rer et ajouter de nouvelles notes de test
                attractions.forEach(attraction => {
                    if (Math.random() < 0.7) { // 70% de chances d'avoir des notes
                        const newRatings = {};
                        familyMembers.forEach(member => {
                            if (Math.random() < 0.6) { // 60% de chances que chaque membre note
                                const randomRating = Math.floor(Math.random() * 10) + 1;
                                newRatings[member.name] = randomRating;
                            }
                        });
                        if (Object.keys(newRatings).length > 0) {
                            // Utilise setDoc pour cr√©er ou remplacer le document de notes pour cette attraction
                            batch.set(doc(ratingsColRef, attraction.id), newRatings);
                        }
                    }
                });

                await batch.commit(); // Ex√©cute toutes les op√©rations en une seule fois
                showCustomAlert("Notes de test g√©n√©r√©es et sauvegard√©es !");

                // R√©initialise les filtres et le tri apr√®s la g√©n√©ration des notes
                zoneFilterSelect.value = 'all';
                filterUnratedOnly = false;
                showUnratedButton.textContent = 'Voir les non not√©es';
                if (sortAscending) {
                    sortAscending = false;
                    sortByRatingButton.classList.remove('active');
                    sortByRatingButton.textContent = 'Trier par note';
                }
                attractionSearchInput.value = ''; // R√©initialise la recherche
                searchQuery = '';
                // Les affichages seront mis √† jour par l'onSnapshot
            } catch (error) {
                console.error("Erreur lors de la g√©n√©ration des notes de test :", error);
                showCustomAlert("Erreur lors de la g√©n√©ration des notes de test. Veuillez r√©essayer.");
            } finally {
                hideLoading();
            }
        }

        async function deleteAllRatings() {
            if (!db) {
                showCustomAlert("Firebase n'est pas initialis√©. Veuillez r√©essayer.");
                return;
            }

            showCustomConfirm("Voulez-vous vraiment supprimer TOUTES les notes ?", async (confirmed) => {
                if (confirmed) {
                    showLoading();
                    try {
                        const ratingsColRef = collection(db, `artifacts/${appId}/public/data/ratings`);
                        const existingRatingsSnapshot = await getDocs(ratingsColRef);
                        // Utilisation de writeBatch(db) pour cr√©er un nouveau batch
                        const batch = writeBatch(db);

                        existingRatingsSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });

                        await batch.commit();
                        showCustomAlert("Toutes les notes ont √©t√© supprim√©es de Firebase !");
                        // Les affichages seront mis √† jour par l'onSnapshot
                    } catch (error) {
                        console.error("Erreur lors de la suppression de toutes les notes :", error);
                        showCustomAlert("Erreur lors de la suppression de toutes les notes. Veuillez r√©essayer.");
                    } finally {
                        hideLoading();
                    }
                } else {
                    showCustomAlert("Suppression des notes annul√©e.");
                }
            });
        }


        function updateRatingsDisplay() {
            if (!currentAttraction) return;
            const attractionId = currentAttraction.id;
            const currentAttractionRatings = allRatings[attractionId] || {};
            familyRatingsList.innerHTML = '';
            let totalScore = 0;
            let numRatings = 0;
            familyMembers.forEach(member => {
                const li = document.createElement('li');
                const score = currentAttractionRatings[member.name] !== undefined ? currentAttractionRatings[member.name] : 'N/A';
                li.innerHTML = `
                    ${member.name} :
                    <span class="score-value">
                        <span class="score-${member.name.toLowerCase()}">${score}</span>
                        ${score !== 'N/A' ? `<span class="delete-rating-icon" onclick="deleteRating('${attractionId}', '${member.name}')">‚úñÔ∏è</span>` : ''}
                    </span>
                `;
                familyRatingsList.appendChild(li);
                if (score !== 'N/A') {
                    totalScore += score;
                    numRatings++;
                }
            });
            if (numRatings > 0) {
                const average = (totalScore / numRatings).toFixed(1);
                averageRatingSpan.textContent = average;
            } else {
                averageRatingSpan.textContent = 'N/A';
            }
        }

        async function deleteRating(attractionId, userName) {
            if (!db) {
                showCustomAlert("Firebase n'est pas initialis√©. Veuillez r√©essayer.");
                return;
            }

            showCustomConfirm(`Voulez-vous vraiment supprimer la note de ${userName} pour cette attraction ?`, async (confirmed) => {
                if (confirmed) {
                    showLoading();
                    try {
                        const ratingDocRef = doc(db, `artifacts/${appId}/public/data/ratings`, attractionId);
                        const currentRatings = allRatings[attractionId] || {};

                        // Cr√©e un nouvel objet sans la note du membre
                        const updatedRatings = { ...currentRatings };
                        delete updatedRatings[userName];

                        if (Object.keys(updatedRatings).length === 0) {
                            // Si plus aucune note pour cette attraction, supprime le document de notes
                            await deleteDoc(ratingDocRef);
                        } else {
                            // Sinon, met √† jour le document avec les notes restantes
                            await setDoc(ratingDocRef, updatedRatings);
                        }

                        showCustomAlert(`Note de ${userName} supprim√©e !`);
                        // Les affichages seront mis √† jour par l'onSnapshot
                    } catch (error) {
                        console.error("Erreur lors de la suppression de la note :", error);
                        showCustomAlert("Erreur lors de la suppression de la note. Veuillez r√©essayer.");
                    } finally {
                        hideLoading();
                    }
                } else {
                    showCustomAlert(`Suppression de la note de ${userName} annul√©e.`);
                }
            });
        }

        function renderIndividualRatingsForPerson() {
            individualRatingsList.innerHTML = '';
            const selectedPersonName = personSelectForStats.value;
            if (!selectedPersonName) {
                individualRatingsList.innerHTML = '<li>S√©lectionnez une personne pour voir ses notes.</li>';
                return;
            }
            let ratingsData = [];
            attractions.forEach(attraction => {
                const rating = allRatings[attraction.id] && allRatings[attraction.id][selectedPersonName] !== undefined
                               ? allRatings[attraction.id][selectedPersonName]
                               : 'N/A';
                ratingsData.push({ attractionName: attraction.name, rating: rating });
            });
            ratingsData.sort((a, b) => {
                const ratingA = a.rating === 'N/A' ? -1 : a.rating;
                const ratingB = b.rating === 'N/A' ? -1 : b.rating;
                return ratingB - ratingA; // Trie du plus grand au plus petit
            });
            let hasRatings = false;
            ratingsData.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.attractionName} : `;
                const scoreSpan = document.createElement('span');
                scoreSpan.textContent = item.rating;
                scoreSpan.className = `score-${selectedPersonName.toLowerCase()}`;
                li.appendChild(scoreSpan);
                individualRatingsList.appendChild(li);
                if (item.rating !== 'N/A') {
                    hasRatings = true;
                }
            });
            if (!hasRatings && selectedPersonName !== "") {
                individualRatingsList.innerHTML = `<li>${selectedPersonName} n'a pas encore not√© d'attractions.</li>`;
            }
        }

        function renderAverageByPerson() {
            averageByPersonList.innerHTML = '';
            const personScores = {};
            familyMembers.forEach(member => {
                personScores[member.name] = { total: 0, count: 0 };
            });
            for (const attractionId in allRatings) {
                const attractionRatings = allRatings[attractionId];
                for (const memberName in attractionRatings) {
                    if (personScores[memberName]) {
                        personScores[memberName].total += attractionRatings[memberName];
                        personScores[memberName].count++;
                    }
                }
            }
            const averagePersonData = [];
            familyMembers.forEach(member => {
                const data = personScores[member.name];
                const average = data.count > 0 ? parseFloat((data.total / data.count).toFixed(1)) : 'N/A';
                averagePersonData.push({ name: member.name, average: average, colorClass: `score-${member.name.toLowerCase()}` });
            });
            averagePersonData.sort((a, b) => {
                const avgA = a.average === 'N/A' ? -1 : a.average;
                const avgB = b.average === 'N/A' ? -1 : b.average;
                return avgB - avgA;
            });
            if (averagePersonData.every(data => data.average === 'N/A')) {
                averageByPersonList.innerHTML = '<li>Aucune note enregistr√©e pour calculer les moyennes par personne.</li>';
                return;
            }
            averagePersonData.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.name} : `;
                const scoreSpan = document.createElement('span');
                scoreSpan.textContent = item.average !== 'N/A' ? `${item.average}/10` : 'N/A';
                scoreSpan.className = item.colorClass;
                li.appendChild(scoreSpan);
                averageByPersonList.appendChild(li);
            });
        }

        function renderAverageByZone() {
            averageByZoneList.innerHTML = '';
            const zoneScores = {};
            attractions.forEach(attraction => {
                const zone = attraction.zone;
                if (!zoneScores[zone]) {
                    zoneScores[zone] = { total: 0, count: 0 };
                }
                const attractionRatings = allRatings[attraction.id] || {};
                for (const memberName in attractionRatings) {
                    zoneScores[zone].total += attractionRatings[memberName];
                    zoneScores[zone].count++;
                }
            });
            let averagesData = [];
            for (const zone in zoneScores) {
                const data = zoneScores[zone];
                const average = data.count > 0 ? parseFloat((data.total / data.count).toFixed(1)) : 'N/A';
                averagesData.push({ name: zone, average: average });
            }
            averagesData.sort((a, b) => {
                const avgA = a.average === 'N/A' ? -1 : a.average;
                const avgB = b.average === 'N/A' ? -1 : b.average;
                return avgB - avgA;
            });
            if (averagesData.every(data => data.average === 'N/A')) {
                averageByZoneList.innerHTML = '<li>Aucune note enregistr√©e pour calculer les moyennes par zone.</li>';
                return;
            }
            averagesData.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.name} : `;
                const scoreSpan = document.createElement('span');
                scoreSpan.textContent = item.average !== 'N/A' ? `${item.average}/10` : 'N/A';
                scoreSpan.style.color = item.average !== 'N/A' ? '#008080' : '#888';
                li.appendChild(scoreSpan);
                averageByZoneList.appendChild(li);
            });
        }

        function renderAverageByCategory() {
            averageByCategoryList.innerHTML = '';
            const categoryScores = {};
            attractions.forEach(attraction => {
                const category = attraction.category;
                if (!categoryScores[category]) {
                    categoryScores[category] = { total: 0, count: 0 };
                }
                const attractionRatings = allRatings[attraction.id] || {};
                for (const memberName in attractionRatings) {
                    categoryScores[category].total += attractionRatings[memberName];
                    categoryScores[category].count++;
                }
            });
            let averagesData = [];
            for (const category in categoryScores) {
                const data = categoryScores[category];
                const average = data.count > 0 ? parseFloat((data.total / data.count).toFixed(1)) : 'N/A';
                averagesData.push({ name: category, average: average });
            }
            averagesData.sort((a, b) => {
                const avgA = a.average === 'N/A' ? -1 : a.average;
                const avgB = b.average === 'N/A' ? -1 : b.average;
                return avgB - avgA;
            });
            if (averagesData.every(data => data.average === 'N/A')) {
                averageByCategoryList.innerHTML = '<li>Aucune note enregistr√©e pour calculer les moyennes par cat√©gorie.</li>';
                return;
            }
            averagesData.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.name} : `;
                const scoreSpan = document.createElement('span');
                scoreSpan.textContent = item.average !== 'N/A' ? `${item.average}/10` : 'N/A';
                scoreSpan.style.color = item.average !== 'N/A' ? '#008080' : '#888';
                li.appendChild(scoreSpan);
                averageByCategoryList.appendChild(li);
            });
        }

        function triggerConfetti() {
            const confettiContainer = document.getElementById('confetti-container');
            const colors = ['#FFD700', '#FF69B4', '#ADD8E6', '#FF4500']; // Removed green color
            const numConfetti = 50;
            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.setProperty('--color', colors[Math.floor(Math.random() * colors.length)]);
                confetti.style.setProperty('--duration', `${Math.random() * 2 + 3}s`);
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * -20}vh`;
                confettiContainer.appendChild(confetti);
                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }

        function showCustomAlert(message) {
            const alertBox = document.createElement('div');
            alertBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #4CAF50;
                color: white;
                padding: 20px 30px;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                font-family: 'Comic Sans MS', cursive, sans-serif;
                font-size: 1.2em;
                z-index: 2000;
                opacity: 0;
                transition: opacity 0.3s ease-in-out;
                max-width: 80vw;
                word-wrap: break-word;
            `;
            alertBox.textContent = message;
            document.body.appendChild(alertBox);
            setTimeout(() => {
                alertBox.style.opacity = 1;
            }, 10);
            setTimeout(() => {
                alertBox.style.opacity = 0;
                alertBox.addEventListener('transitionend', () => alertBox.remove());
            }, 3000);
        }

        function showCustomConfirm(message, callback) {
            modalTitle.textContent = "Confirmer l'action";
            modalMessage.textContent = message;
            customConfirmModal.classList.add('visible');
            modalConfirmYes.onclick = null;
            modalConfirmNo.onclick = null;
            modalConfirmYes.onclick = () => {
                customConfirmModal.classList.remove('visible');
                callback(true);
            };
            modalConfirmNo.onclick = () => {
                customConfirmModal.classList.remove('visible');
                callback(false);
            };
        }

        // La fonction shareAttraction a √©t√© supprim√©e.

        // Fonction pour peupler les attractions initiales si la collection est vide
        async function populateInitialAttractions() {
            console.log("POPULATE INITIAL ATTRACTIONS: V√©rification des donn√©es initiales.");
            const attractionsColRef = collection(db, `artifacts/${appId}/public/data/attractions`);
            const snapshot = await getDocs(attractionsColRef);

            // V√©rifie si la collection est vide.
            if (snapshot.empty) {
                console.log("POPULATE INITIAL ATTRACTIONS: Aucune attraction trouv√©e dans Firebase, les donn√©es initiales ne seront pas charg√©es depuis le code.");
                console.log("POPULATE INITIAL ATTRACTIONS: Veuillez ajouter des attractions via l'interface de gestion ou importer des donn√©es si n√©cessaire.");
            } else {
                console.log("POPULATE INITIAL ATTRACTIONS: Attractions d√©j√† pr√©sentes dans Firebase.");
            }
        }

        // Fonction pour configurer les √©couteurs en temps r√©el
        async function setupFirebaseListeners() {
            console.log("FIRESTORE: Attaching onSnapshot listener for attractions...");
            // √âcouteur en temps r√©el pour les attractions
            const attractionsColRef = collection(db, `artifacts/${appId}/public/data/attractions`);
            onSnapshot(attractionsColRef, (snapshot) => {
                attractions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("FIRESTORE: Attractions data received. Count:", attractions.length);

                // Mettre √† jour l'interface utilisateur d√©pendante des attractions
                renderAttractionList();
                renderManagedAttractionsList();
                populateZoneFilter();
                if (attractionDetailPage.style.display === 'block' && currentAttraction) {
                    currentAttraction = attractions.find(att => att.id === currentAttraction.id); // Rafra√Æchit currentAttraction
                    if (currentAttraction) {
                         // Met √† jour l'affichage uniquement si currentAttraction est toujours valide
                        detailAttractionName.textContent = currentAttraction.name;
                        detailAttractionPark.textContent = currentAttraction.park;
                        detailAttractionZone.textContent = currentAttraction.zone;
                        detailAttractionCategory.textContent = currentAttraction.category;
                        if (currentAttraction.url) {
                            detailAttractionUrl.href = currentAttraction.url;
                            detailAttractionUrl.style.display = 'inline';
                        } else {
                            detailAttractionUrl.style.display = 'none';
                        }
                        if (currentAttraction.imageUrl) {
                            detailAttractionImage.src = currentAttraction.imageUrl;
                            detailAttractionImage.alt = `Image de ${currentAttraction.name}`;
                            detailAttractionImage.style.display = 'block';
                        } else {
                            detailAttractionImage.src = "https://placehold.co/400x250/cccccc/333333?text=Image+non+disponible";
                            detailAttractionImage.alt = "Image non disponible";
                            d
etailAttractionImage.style.display = 'block';
                        }
                    } else {
                        // Si l'attraction actuelle a √©t√© supprim√©e, revenir √† la liste principale
                        showMainListPage();
                    }
                }
                if (statsPage.style.display === 'block') {
                    renderIndividualRatingsForPerson();
                    renderAverageByPerson();
                    renderAverageByZone();
                    renderAverageByCategory();
                }
                attractionsLoaded = true; // Marque les attractions comme charg√©es
                checkAndHideLoading(); // V√©rifie si tout est charg√©
            }, (error) => {
                console.error("FIRESTORE ERROR (Attractions): Erreur lors de l'√©coute des attractions:", error);
                showCustomAlert("Erreur de chargement des attractions en temps r√©el.");
                attractionsLoaded = true; // Marque comme charg√© m√™me en cas d'erreur
                checkAndHideLoading();
            });

            console.log("FIRESTORE: Attaching onSnapshot listener for ratings...");
            // √âcouteur en temps r√©el pour les notes
            const ratingsColRef = collection(db, `artifacts/${appId}/public/data/ratings`);
            onSnapshot(ratingsColRef, (snapshot) => {
                // Efface les notes existantes avant de les remplir √† partir du snapshot
                for (const key in allRatings) {
                    delete allRatings[key];
                }
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    allRatings[doc.id] = data;
                });
                console.log("FIRESTORE: Ratings data received. Count:", Object.keys(allRatings).length);

                // Mettre √† jour l'interface utilisateur d√©pendante des notes
                renderAttractionList(); // Pour mettre √† jour les moyennes sur les cartes
                if (attractionDetailPage.style.display === 'block') {
                    updateRatingsDisplay(); // Pour mettre √† jour les notes sur la page de d√©tail
                }
                if (statsPage.style.display === 'block') {
                    renderIndividualRatingsForPerson();
                    renderAverageByPerson();
                    renderAverageByZone();
                    renderAverageByCategory();
                }
                ratingsLoaded = true; // Marque les notes comme charg√©es
                checkAndHideLoading(); // V√©rifie si tout est charg√©
            }, (error) => {
                console.error("FIRESTORE ERROR (Ratings): Erreur lors de l'√©coute des notes:", error);
                showCustomAlert("Erreur de chargement des notes en temps r√©el.");
                ratingsLoaded = true; // Marque comme charg√© m√™me en cas d'erreur
                checkAndHideLoading();
            });
        }


        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM CONTENT LOADED: Initialisation de l'application.");
            showLoading(); // Affiche le spinner de chargement imm√©diatement

            // --- V√©rification de la configuration Firebase ---
            // La configuration est maintenant cod√©e en dur, donc cette v√©rification devrait toujours passer.
            if (!firebaseConfig || !firebaseConfig.projectId) {
                console.error("FIREBASE CONFIG ERROR: firebaseConfig ou projectId manquant. firebaseConfig:", firebaseConfig);
                showCustomAlert("Erreur: La configuration Firebase est incompl√®te. Veuillez vous assurer que votre projet Firebase est correctement configur√© et qu'une application Web y est ajout√©e.");
                hideLoading(); // Masque le spinner car nous ne pouvons pas continuer sans config
                return; // Arr√™te l'ex√©cution
            }
            console.log("FIREBASE CONFIG OK: projectId trouv√©:", firebaseConfig.projectId);

            try {
                // Initialisation de Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("FIREBASE INIT: Firebase initialis√©.");
            } catch (initError) {
                console.error("FIREBASE INIT ERROR: Erreur lors de l'initialisation de Firebase:", initError);
                showCustomAlert("Erreur critique: Impossible d'initialiser Firebase. Veuillez v√©rifier la console pour plus de d√©tails.");
                hideLoading();
                return;
            }


            // G√©rer l'√©tat d'authentification
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("AUTH: Utilisateur Firebase connect√© avec UID:", userId);
                } else {
                    // Si pas d'utilisateur, se connecter anonymement
                    try {
                        console.log("AUTH: Tentative de connexion anonyme...");
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("AUTH: Connexion avec jeton personnalis√© r√©ussie.");
                        } else {
                            await signInAnonymously(auth);
                            console.log("AUTH: Connexion anonyme r√©ussie.");
                        }
                        userId = auth.currentUser.uid;
                        console.log("AUTH: Utilisateur actuel UID:", userId);
                    } catch (error) {
                        console.error("AUTH ERROR: Erreur lors de la connexion √† Firebase:", error);
                        showCustomAlert("Erreur de connexion √† Firebase. Certaines fonctionnalit√©s pourraient √™tre limit√©es.");
                        // S'assurer que le chargement est masqu√© m√™me si l'authentification √©choue
                        attractionsLoaded = true;
                        ratingsLoaded = true;
                        checkAndHideLoading(); // Tente de masquer le chargement m√™me en cas d'√©chec d'authentification
                        return; // Arr√™te l'ex√©cution si l'authentification √©choue
                    }
                }
                // Une fois l'authentification pr√™te, peupler les donn√©es initiales si n√©cessaire, puis configurer les √©couteurs
                await populateInitialAttractions(); // S'assure que les donn√©es initiales sont l√† avant d'√©couter
                setupFirebaseListeners(); // Configure les √©couteurs en temps r√©el
            });


            renderFamilyRaterButtons();
            renderRatingButtons(); // Appelle la fonction pour g√©n√©rer les boutons de notation au chargement
            
            // √âcouteurs pour les filtres et le tri
            zoneFilterSelect.addEventListener('change', () => {
                filterUnratedOnly = false;
                showUnratedButton.textContent = 'Voir les non not√©es';
                sortAscending = false;
                sortByRatingButton.classList.remove('active');
                sortByRatingButton.textContent = 'Trier par note';
                // La recherche n'est pas r√©initialis√©e ici
                renderAttractionList();
            });
            showUnratedButton.addEventListener('click', () => {
                filterUnratedOnly = !filterUnratedOnly;
                showUnratedButton.textContent = filterUnratedOnly ? 'Voir toutes les attractions' : 'Voir les non not√©es';
                zoneFilterSelect.value = 'all';
                sortAscending = false;
                sortByRatingButton.classList.remove('active');
                sortByRatingButton.textContent = 'Trier par note';
                attractionSearchInput.value = ''; // R√©initialise la recherche
                searchQuery = '';
                renderAttractionList();
            });
            sortByRatingButton.addEventListener('click', () => {
                sortAscending = !sortAscending;
                if (sortAscending) {
                    sortByRatingButton.classList.add('active');
                    sortByRatingButton.textContent = 'Tri√© par note (Desc)';
                } else {
                    sortByRatingButton.classList.remove('active');
                    sortByRatingButton.textContent = 'Trier par note';
                }
                filterUnratedOnly = false;
                showUnratedButton.textContent = 'Voir les non not√©es';
                zoneFilterSelect.value = 'all';
                attractionSearchInput.value = ''; // R√©initialise la recherche
                searchQuery = '';
                renderAttractionList();
            });

            // Nouvel √©couteur pour la recherche
            attractionSearchInput.addEventListener('input', () => {
                searchQuery = attractionSearchInput.value.trim();
                // R√©initialiser les autres filtres et le tri lors de la recherche
                zoneFilterSelect.value = 'all';
                filterUnratedOnly = false;
                showUnratedButton.textContent = 'Voir les non not√©es';
                sortAscending = false;
                sortByRatingButton.classList.remove('active');
                sortByRatingButton.textContent = 'Trier par note';
                renderAttractionList();
            });

            personSelectForStats.addEventListener('change', renderIndividualRatingsForPerson);

            // Gestionnaire pour le bouton OK de la modale de mot de passe
            passwordOkButton.addEventListener('click', () => {
                const enteredPassword = passwordInput.value;
                if (enteredPassword === CORRECT_PASSWORD) {
                    passwordModal.classList.remove('visible');
                    if (currentPasswordAction === 'manageAttractions') {
                        showManageAttractionsPage();
                    } else if (currentPasswordAction === 'testNotes') {
                        showTestNotesOptionsModal();
                    }
                    currentPasswordAction = null; // R√©initialise le flag
                } else {
                    showCustomAlert("Mot de passe incorrect. Acc√®s refus√©.");
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            });

            passwordCancelButton.addEventListener('click', () => {
                passwordModal.classList.remove('visible');
                showCustomAlert("Acc√®s annul√©.");
                currentPasswordAction = null; // R√©initialise le flag
            });
            passwordInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    passwordOkButton.click();
                }
            });

            // Gestionnaires pour les boutons de la nouvelle modale d'options de notes de test
            generateTestNotesButton.addEventListener('click', () => {
                generateTestRatings(); // Appelle la fonction existante
                testNotesOptionsModal.classList.remove('visible'); // Ferme la modale d'options
            });

            deleteAllNotesButton.addEventListener('click', () => {
                testNotesOptionsModal.classList.remove('visible'); // Ferme la modale d'options AVANT la confirmation
                deleteAllRatings(); // Appelle la nouvelle fonction de suppression qui contient la confirmation
            });

            cancelTestNotesButton.addEventListener('click', () => {
                testNotesOptionsModal.classList.remove('visible'); // Ferme la modale d'options
            });
        });

        window.showDetailPage = showDetailPage;
        window.showStatsPage = showStatsPage;
        window.requestManageAttractionsAccess = requestManageAttractionsAccess;
        window.requestTestNotesManagementAccess = requestTestNotesManagementAccess;
        window.showMainListPage = showMainListPage;
        window.saveAttraction = saveAttraction;
        window.openAttractionForm = openAttractionForm;
        window.deleteAttraction = deleteAttraction;
        window.deleteRating = deleteRating;
    </script>
    <style>
        /* Styles g√©n√©raux pour le corps de la page */
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #FFD700, #FF69B4);
            color: #333;
            margin: 0;
            padding: 15px; /* R√©duit le padding global car le footer n'est plus fixe */
            text-align: center;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Aligne le contenu en haut */
            align-items: center;
            position: relative;
        }

        /* Conteneur principal de l'application */
        .container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            max-width: 900px;
            width: 100%;
            margin: 15px auto;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            flex-grow: 1; /* Permet au conteneur de prendre l'espace disponible */
        }

        /* Titres */
        h1, h2, h3 {
            color: #8B0000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            font-size: 1.8em;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 1.5em;
        }
        h3 {
            font-size: 1.3em;
            color: #D2691E;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        /* En-t√™te de la page principale */
        .header {
            margin-bottom: 25px;
        }

        /* Conteneur des boutons d'action en haut */
        .action-buttons-top {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .action-buttons-top button {
            background-color: #4682B4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            flex-grow: 1;
            max-width: 180px;
            box-sizing: border-box;
        }
        .action-buttons-top button:hover {
            background-color: #36648B;
            transform: scale(1.02);
        }
        .action-buttons-top button.generate-button {
            background-color: #8A2BE2;
        }
        .action-buttons-top button.generate-button:hover {
            background-color: #6A1BA0;
        }
        .action-buttons-top button.manage-button {
            background-color: #20B2AA;
        }
        .action-buttons-top button.manage-button:hover {
            background-color: #1A8B83;
        }

        /* Conteneur des filtres et de la recherche */
        .filters-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        .filters-container label {
            font-weight: bold;
            color: #555;
            margin-right: 5px;
        }
        .filters-container select,
        .filters-container button,
        .filters-container input[type="text"] { /* Style pour le champ de recherche */
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #8B0000;
            background-color: #FFF0F5;
            font-size: 1em;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            color: #333;
            cursor: pointer;
            width: 100%;
            max-width: 250px;
            box-sizing: border-box;
        }
        .filters-container button {
            background-color: #FF8C00;
            color: white;
            border: none;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .filters-container button:hover {
            background-color: #CC7000;
            transform: scale(1.02);
        }
        /* Style sp√©cifique pour le champ de recherche */
        .filters-container input[type="text"] {
            cursor: text;
        }

        /* Liste des attractions (grille responsive) */
        .attraction-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        /* Carte d'attraction */
        .attraction-card {
            background-color: #FFF;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-align: left;
            position: relative;
            border: 3px solid #ADD8E6;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .attraction-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 25px rgba(0,0,0,0.15);
        }
        .attraction-card h3 {
            color: #008080;
            margin-top: 0;
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        .attraction-card p {
            margin: 3px 0;
            font-size: 0.9em;
        }
        .attraction-card p strong {
            color: #555;
        }
        .attraction-card .category {
            display: inline-block;
            background-color: #ADD8E6;
            color: #333;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 8px;
        }
        .attraction-card .category.Action { background-color: #FF6347; color: white; }
        .attraction-card .category.Famille { background-color: #FFD700; }
        .attraction-card .category.Enfant { background-color: #98FB98; }
        .attraction-card .average-on-card {
            font-size: 1em;
            font-weight: bold;
            color: #D2691E;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .park-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
            vertical-align: middle;
        }
        .park-indicator.europa-park {
            background-color: #00008B;
        }
        .park-indicator.rulantica {
            background-color: #40E0D0;
        }
        /* Style pour l'indicateur dans le select de filtre (maintenant remplac√© par √©mojis) */
        /* .park-indicator-inline {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
            vertical-align: middle;
            border: 1px solid rgba(0,0,0,0.2);
        }
        .park-indicator-inline.europa-park {
            background-color: #00008B;
        }
        .park-indicator-inline.rulantica {
            background-color: #40E0D0;
        } */

        .attraction-card button.rate-attraction-button {
            background-color: #FF4500;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            margin-top: 15px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            box-sizing: border-box;
        }
        .attraction-card button.rate-attraction-button:hover {
            background-color: #E03E00;
            transform: scale(1.02);
        }
        .attraction-card .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .attraction-card .card-actions button {
            flex-grow: 1;
            margin-top: 0;
        }
        .attraction-card .card-actions button.edit-button {
            background-color: #FFD700;
            color: #333;
        }
        .attraction-card .card-actions button.edit-button:hover {
            background-color: #FFC400;
        }
        .attraction-card .card-actions button.delete-button {
            background-color: #DC143C;
        }
        .attraction-card .card-actions button.delete-button:hover {
            background-color: #B01030;
        }

        /* Page de d√©tail de l'attraction */
        .detail-page {
            display: none;
            text-align: center;
        }
        .detail-page h2 {
            font-size: 1.8em;
            margin-bottom: 15px;
        }
        .detail-page .info-block {
            background-color: #F8F8FF;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .detail-page .info-block p {
            font-size: 1em;
            margin: 8px 0;
        }
        .detail-page .image-zone {
            margin-top: 20px;
            margin-bottom: 20px;
            background-color: #F0F8FF;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .detail-page .image-zone img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: block;
            margin: 0 auto;
        }
        .detail-page .rating-section {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        .detail-page .rating-section h3 {
            font-size: 1.2em;
            margin-bottom: 0;
        }
        /* Styles pour les nouveaux boutons de notation */
        .rating-buttons-container {
            display: flex;
            flex-wrap: wrap; /* Permet aux boutons de passer √† la ligne */
            justify-content: center;
            gap: 8px; /* Espacement r√©duit entre les boutons */
            margin-top: 15px;
            width: 100%;
            max-width: 600px; /* Limite la largeur pour √©viter l'√©tirement excessif */
        }
        .rating-button {
            width: 40px; /* Taille fixe pour chaque bouton */
            height: 40px;
            border-radius: 50%; /* Boutons ronds */
            border: 2px solid #ccc;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .rating-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .rating-button.selected {
            border-color: #4169E1; /* Couleur de bordure pour le bouton s√©lectionn√© */
            transform: scale(1.15);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        /* Couleurs pour l'√©chelle de notes (du rouge au vert) */
        .rating-1 { background-color: #FF4500; } /* Rouge vif */
        .rating-2 { background-color: #FF6347; } /* Tomato */
        .rating-3 { background-color: #FF7F50; } /* Coral */
        .rating-4 { background-color: #FFA07A; } /* LightSalmon */
        .rating-5 { background-color: #FFD700; } /* Gold */
        .rating-6 { background-color: #ADFF2F; } /* GreenYellow */
        .rating-7 { background-color: #7CFC00; } /* LawnGreen */
        .rating-8 { background-color: #32CD32; } /* LimeGreen */
        .rating-9 { background-color: #008000; } /* Green */
        .rating-10 { background-color: #006400; } /* DarkGreen */


        /* Boutons des membres de la famille pour la notation */
        .family-rater-buttons {
            display: flex;
            flex-wrap: nowrap; /* Force les boutons √† rester sur une seule ligne */
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
        }
        .family-rater-buttons button {
            border: none;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            flex-grow: 1;
            flex-shrink: 1; /* Permet aux boutons de r√©tr√©cir si n√©cessaire */
            min-width: 60px; /* Emp√™che les boutons de devenir trop petits */
            box-sizing: border-box;
        }
        .family-rater-buttons button.papa { background-color: #4169E1; color: white; }
        .family-rater-buttons button.papa:hover { background-color: #3558B6; }
        .family-rater-buttons button.maman { background-color: #FF8C00; color: white; }
        .family-rater-buttons button.maman:hover { background-color: #CC7000; }
        .family-rater-buttons button.ceylian { background-color: #DC143C; color: white; }
        .family-rater-buttons button.ceylian:hover { background-color: #B01030; }
        /* MODIFICATION ICI: Couleur du bouton Clo√©lie */
        .family-rater-buttons button.cloelie { background-color: #000000; color: white; } /* Noir avec texte blanc */
        .family-rater-buttons button.cloelie:hover { background-color: #333333; } /* Un peu plus clair au survol */

        .detail-page .scores-display {
            margin-top: 25px;
            background-color: #FFFACD;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .detail-page .scores-display h3 {
            color: #D2691E;
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        .detail-page .scores-display ul {
            list-style: none;
            padding: 0;
        }
        .detail-page .scores-display ul li {
            background-color: #FFE4B5;
            margin: 6px 0;
            padding: 8px 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 0.95em;
        }
        .detail-page .scores-display ul li .score-value {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .detail-page .scores-display ul li .score-papa { color: #4169E1; }
        .detail-page .scores-display ul li .score-maman { color: #FF8C00; }
        .detail-page .scores-display ul li .score-ceylian { color: #DC143C; }
        .detail-page .scores-display ul li .score-cloelie { color: #000000; } /* Assure la couleur du texte de la note aussi */
        .delete-rating-icon {
            cursor: pointer;
            color: #DC143C;
            font-size: 1.2em;
            line-height: 1;
            padding: 2px;
            opacity: 0.7;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .delete-rating-icon:hover {
            opacity: 1;
            transform: scale(1.2);
        }
        .detail-page .scores-display .average-score {
            font-size: 1.3em;
            color: #8B0000;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #D2691E;
        }
        .back-button {
            background-color: #FFA07A;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin-top: 25px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            max-width: 300px;
            box-sizing: border-box;
        }
        .back-button:hover {
            background-color: #FF7F50;
            transform: scale(1.02);
        }
        /* Le bouton de partage a √©t√© supprim√© */

        /* Page des statistiques */
        .stats-page {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .stats-page .stats-section {
            background-color: #F8F8FF;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .stats-page .stats-section select {
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #4682B4;
            background-color: #E6E6FA;
            font-size: 1em;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            color: #333;
            cursor: pointer;
            width: 100%;
            max-width: 250px;
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        .stats-page .stats-list {
            list-style: none;
            padding: 0;
        }
        .stats-page .stats-list li {
            background-color: #E0FFFF;
            margin: 8px 0;
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 0.95em;
        }
        .stats-page .stats-list li .score-papa { color: #4169E1; }
        .stats-page .stats-list li .score-maman { color: #FF8C00; }
        .stats-page .stats-list li .score-ceylian { color: #DC143C; }
        .stats-page .stats-list li .score-cloelie { color: #000000; } /* Assure la couleur du texte de la note aussi */
        .stats-page .average-display {
            font-size: 1.1em;
            color: #8B0000;
            margin-top: 10px;
            font-weight: bold;
        }

        /* Page de gestion des attractions */
        .manage-attractions-page {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .manage-attractions-page .form-section {
            background-color: #F8F8FF;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .manage-attractions-page .form-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            text-align: left;
        }
        .manage-attractions-page .form-section input[type="text"],
        .manage-attractions-page .form-section select {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #ADD8E6;
            border-radius: 8px;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            font-size: 1em;
            box-sizing: border-box;
        }
        .manage-attractions-page .form-section button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            max-width: 250px;
            box-sizing: border-box;
        }
        .manage-attractions-page .form-section button:hover {
            background-color: #45a049;
            transform: scale(1.02);
        }
        .manage-attractions-page .current-attractions-list {
            margin-top: 30px;
        }
        .manage-attractions-page .current-attractions-list ul {
            list-style: none;
            padding: 0;
        }
        .manage-attractions-page .current-attractions-list li {
            background-color: #FFE4B5;
            margin: 10px 0;
            padding: 12px 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .manage-attractions-page .current-attractions-list li .attraction-info {
            font-weight: bold;
            color: #333;
            text-align: left;
            width: 100%;
        }
        .manage-attractions-page .current-attractions-list li .attraction-actions {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: flex-end;
        }
        .manage-attractions-page .current-attractions-list li .attraction-actions button {
            padding: 8px 12px;
            font-size: 0.85em;
            border-radius: 8px;
            margin-top: 0;
            width: auto;
            max-width: none;
        }
        .manage-attractions-page .current-attractions-list li .attraction-actions button.edit-button {
            background-color: #FFD700;
            color: #333;
        }
        .manage-attractions-page .current-attractions-list li .attraction-actions button.edit-button:hover {
            background-color: #FFC400;
        }
        .manage-attractions-page .current-attractions-list li .attraction-actions button.delete-button {
            background-color: #DC143C;
        }
        .manage-attractions-page .current-attractions-list li .attraction-actions button.delete-button:hover {
            background-color: #B01030;
        }

        /* Modale de confirmation (cach√©e par d√©faut) */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .custom-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .custom-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 90vw;
            width: 400px;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            color: #333;
        }
        .custom-modal-content h4 {
            margin-top: 0;
            color: #8B0000;
            font-size: 1.4em;
        }
        .custom-modal-content p {
            margin-bottom: 25px;
            font-size: 1.1em;
        }
        .custom-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .custom-modal-buttons button {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .custom-modal-buttons button.confirm-yes {
            background-color: #DC143C;
            color: white;
        }
        .custom-modal-buttons button.confirm-yes:hover {
            background-color: #B01030;
        }
        .custom-modal-buttons button.confirm-no {
            background-color: #ADD8E6;
            color: #333;
        }
        .custom-modal-buttons button.confirm-no:hover {
            background-color: #87CEEB;
        }

        /* Modale de mot de passe */
        .password-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2100;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .password-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .password-modal-content {
            background-color: #FFF;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 90vw;
            width: 350px;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            color: #333;
        }
        .password-modal-content h4 {
            margin-top: 0;
            color: #4682B4;
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        .password-modal-content input[type="password"] {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid #4682B4;
            border-radius: 10px;
            font-size: 1.1em;
            text-align: center;
            box-sizing: border-box;
        }
        .password-modal-content .password-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .password-modal-content .password-buttons button {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: none;
        }
        .password-modal-content .password-buttons button.password-ok {
            background-color: #4CAF50;
            color: white;
        }
        .password-modal-content .password-ok:hover {
            background-color: #45a049;
        }
        .password-modal-content .password-buttons button.password-cancel {
            background-color: #FFD700;
            color: #333;
        }
        .password-modal-content .password-cancel:hover {
            background-color: #FFC400;
        }

        /* Nouvelle Modale d'options pour les notes de test */
        .test-notes-options-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2200; /* Plus √©lev√© que les autres modales */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .test-notes-options-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .test-notes-options-modal-content {
            background-color: #FFF;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 90vw;
            width: 450px;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            color: #333;
        }
        .test-notes-options-modal-content h4 {
            margin-top: 0;
            color: #8A2BE2; /* Couleur violette pour le titre */
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        .test-notes-options-modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .test-notes-options-modal-buttons button {
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
            color: white;
        }
        .test-notes-options-modal-buttons button.generate-test-notes {
            background-color: #8A2BE2; /* Violet */
        }
        .test-notes-options-modal-buttons button.generate-test-notes:hover {
            background-color: #6A1BA0;
            transform: scale(1.02);
        }
        .test-notes-options-modal-buttons button.delete-all-notes {
            background-color: #DC143C; /* Crimson */
        }
        .test-notes-options-modal-buttons button.delete-all-notes:hover {
            background-color: #B01030;
            transform: scale(1.02);
        }
        .test-notes-options-modal-buttons button.cancel-action {
            background-color: #ADD8E6; /* LightBlue */
            color: #333;
        }
        .test-notes-options-modal-buttons button.cancel-action:hover {
            background-color: #87CEEB;
            transform: scale(1.02);
        }

        /* Animation des confettis */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 1000;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--color);
            border-radius: 50%;
            animation: confetti-fall var(--duration) linear forwards;
            opacity: 0;
        }
        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotateZ(0deg) scale(1);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotateZ(720deg) scale(0.5);
                opacity: 0;
            }
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex; /* D√©fini √† none par default */
            justify-content: center;
            align-items: center;
            z-index: 3000;
            font-size: 1.8em;
            color: #8B0000;
            font-weight: bold;
            flex-direction: column;
            gap: 20px;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #FF69B4;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Media Queries pour ajustements sur √©crans plus grands (tablette/desktop) */
        @media (min-width: 768px) {
            body {
                padding-bottom: 15px; /* Revert padding for desktop */
            }
            .header {
                flex-direction: row;
            }
            .filters-container {
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap; /* Permet aux √©l√©ments de filtre de s'enrouler */
            }
            .filters-container select,
            .filters-container button,
            .filters-container input[type="text"] {
                width: auto;
                max-width: none;
            }
            .action-buttons-top {
                flex-direction: row;
                justify-content: center;
            }
            .action-buttons-top button {
                width: auto;
                max-width: none;
            }
            .detail-page .rating-section {
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap; /* Permet aux √©l√©ments de passer √† la ligne si l'√©cran est trop petit */
            }
            .rating-buttons-container {
                width: auto;
                max-width: 600px;
            }
            .family-rater-buttons {
                width: auto;
            }
            .family-rater-buttons button {
                max-width: none;
            }
            .back-button {
                width: auto;
                max-width: none;
            }
            h1 {
                font-size: 2.5em;
            }
            h2 {
                font-size: 2em;
            }
            .manage-attractions-page .current-attractions-list li {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            .manage-attractions-page .current-attractions-list li .attraction-actions {
                width: auto;
            }
        }

    </style>
</head>
<body>
    <div class="confetti-container" id="confetti-container"></div>

    <div id="customConfirmModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <h4 id="modalTitle">Confirmer l'action</h4>
            <p id="modalMessage">√ätes-vous s√ªr de vouloir effectuer cette action ?</p>
            <div class="custom-modal-buttons">
                <button class="confirm-yes" id="modalConfirmYes">Oui</button>
                <button class="confirm-no" id="modalConfirmNo">Non</button>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="password-modal-overlay">
        <div class="password-modal-content">
            <h4>Acc√®s s√©curis√©</h4>
            <p>Veuillez entrer le mot de passe pour g√©rer les attractions :</p>
            <input type="password" id="passwordInput" placeholder="Mot de passe">
            <div class="password-buttons">
                <button class="password-ok" id="passwordOkButton">OK</button>
                <button class="password-cancel" id="passwordCancelButton">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Nouvelle modale pour les options de notes de test -->
    <div id="testNotesOptionsModal" class="test-notes-options-modal-overlay">
        <div class="test-notes-options-modal-content">
            <h4>Options des Notes de Test</h4>
            <div class="test-notes-options-modal-buttons">
                <button class="generate-test-notes" id="generateTestNotesButton">G√©n√©rer des notes de test</button>
                <button class="delete-all-notes" id="deleteAllNotesButton">Supprimer toutes les notes</button>
                <button class="cancel-action" id="cancelTestNotesButton">Annuler</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p>Chargement des donn√©es...</p>
    </div>

    <div class="container">
        <div id="main-list-page">
            <div class="header">
                <h1>üéâ Notes des Attractions üéâ</h1>
                <!-- Boutons d'action d√©plac√©s en haut -->
                <div class="action-buttons-top">
                    <button class="stats-button" onclick="showStatsPage()">Voir les Statistiques</button>
                    <button class="generate-button" onclick="requestTestNotesManagementAccess()">G√©rer les notes de test</button>
                    <button class="manage-button" onclick="requestManageAttractionsAccess()">G√©rer les attractions</button>
                </div>
            </div>
            <h2>Choisissez une attraction √† noter :</h2>
            <div class="filters-container">
                <div>
                    <label for="attractionSearchInput">Rechercher :</label>
                    <input type="text" id="attractionSearchInput" placeholder="Nom de l'attraction">
                </div>
                <div>
                    <label for="zoneFilter">Filtrer par zone :</label>
                    <select id="zoneFilter">
                        <option value="all">Toutes les zones</option>
                    </select>
                </div>
                <button id="showUnratedButton">Voir les non not√©es</button>
                <button id="sortByRatingButton" class="sort-button">Trier par note</button>
            </div>
            <div class="attraction-list" id="attractionList"></div>
        </div>

        <div id="attraction-detail-page" class="detail-page">
            <h2 id="detail-attraction-name"></h2>
            <div class="info-block">
                <p><strong>Parc :</strong> <span id="detail-attraction-park"></span></p>
                <p><strong>Zone th√©matique :</strong> <span id="detail-attraction-zone"></span></p>
                <p><strong>Cat√©gorie :</strong> <span id="detail-attraction-category"></span></p>
                <p><a id="detail-attraction-url" href="#" target="_blank" style="color: #008080; text-decoration: none; font-weight: bold;">Voir sur le site officiel</a></p>
            </div>
            <div class="image-zone">
                <h3>Image de l'attraction :</h3>
                <img id="detail-attraction-image" src="" alt="Image de l'attraction">
            </div>
            <div class="rating-section">
                <h3>Donnez votre note :</h3>
                <div class="rating-buttons-container" id="ratingButtonsContainer">
                    <!-- Les boutons de notation seront g√©n√©r√©s ici par JavaScript -->
                </div>
                <div class="family-rater-buttons" id="familyRaterButtons"></div>
            </div>
            <div class="scores-display">
                <h3>Notes de la famille pour cette attraction :</h3>
                <ul id="familyRatingsList"></ul>
                <p class="average-score">Moyenne : <span id="averageRating">N/A</span></p>
            </div>
            <button class="back-button" onclick="showMainListPage()">Retour aux attractions</button>
        </div>

        <div id="stats-page" class="stats-page">
            <h1>üìä Statistiques des Notes üìä</h1>
            <div class="stats-section">
                <h3>Notes de chaque personne :</h3>
                <select id="personSelectForStats">
                    <option value="">S√©lectionnez une personne</option>
                    <option value="Papa">Papa</option>
                    <option value="Maman">Maman</option>
                    <option value="Ceylian">Ceylian</option>
                    <option value="Clo√©lie">Clo√©lie</option>
                </select>
                <ul id="individualRatingsList" class="stats-list"></ul>
            </div>
            <div class="stats-section">
                <h3>Moyenne par personne :</h3>
                <ul id="averageByPersonList" class="stats-list"></ul>
            </div>
            <div class="stats-section">
                <h3>Moyenne par zone th√©matique :</h3>
                <ul id="averageByZoneList" class="stats-list"></ul>
            </div>
            <div class="stats-section">
                <h3>Moyenne par cat√©gorie :</h3>
                <ul id="averageByCategoryList" class="stats-list"></ul>
            </div>
            <button class="back-button" onclick="showMainListPage()">Retour aux attractions</button>
        </div>

        <div id="manage-attractions-page" class="manage-attractions-page">
            <h1>üõ†Ô∏è G√©rer les Attractions üõ†Ô∏è</h1>
            <div class="form-section">
                <h3 id="attractionFormTitle">Ajouter une nouvelle attraction</h3>
                <input type="hidden" id="attractionIdToEdit">
                <label for="attractionName">Nom de l'attraction :</label>
                <input type="text" id="attractionName" placeholder="Ex: Silver Star">
                <label for="attractionPark">Parc :</label>
                <select id="attractionPark">
                    <option value="Europa-Park">Europa-Park</option>
                    <option value="Rulantica">Rulantica</option>
                </select>
                <label for="attractionZone">Zone th√©matique :</label>
                <input type="text" id="attractionZone" placeholder="Ex: France">
                <label for="attractionCategory">Cat√©gorie :</label>
                <select id="attractionCategory">
                    <option value="Action">Action</option>
                    <option value="Famille">Famille</option>
                    <option value="Enfant">Enfant</option>
                </select>
                <label for="attractionUrl">URL (optionnel) :</label>
                <input type="text" id="attractionUrl" placeholder="URL du site officiel">
                <label for="attractionImageUrl">URL de l'image (optionnel) :</label>
                <input type="text" id="attractionImageUrl" placeholder="URL de l'image de l'attraction">
                <button id="saveAttractionButton" onclick="saveAttraction()">Ajouter l'attraction</button>
            </div>
            <div class="current-attractions-list">
                <h3>Attractions actuelles :</h3>
                <ul id="currentManagedAttractionsList"></ul>
            </div>
            <button class="back-button" onclick="showMainListPage()">Retour aux attractions</button>
        </div>
    </div>
</body>
</html>
